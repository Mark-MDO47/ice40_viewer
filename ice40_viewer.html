<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>ICE40 layout viewer</title>

  <script type="text/javascript" src="myutil.js"></script>
  <script type="text/javascript" src="gfx.js"></script>
  <script type="text/javascript" src="ice40.js"></script>
  <script type="text/javascript" src="lutfunction.js"></script>
  <script type="text/javascript">
var x = 0;
  </script>

</head>
<body>

  <h1>ICE40 layout viewer</h1>
    <h2>
      <span id="statustext">Loading...</span>
    </h2>
  <div>
  <canvas id="canvas1" width=1500 height=1900 style="border: 1px solid #000000;"> </canvas>
  </div>

  <div>Load .asc: <input type="file" id="ascfileinput"/></div>
  <script>

var datafilename = [ "chipdb-8k.txt" ];
var ascfilename = [ "bramtest.asc" ];

var chipdb = { };
var g_asc_data = { };
var g_symtable = { };
var g_tiles;
var g_net_connection;
var g_supernets;

var dataLoadComplete = false;
var mouseDown = false;
var draggingMouse = false;
var dragStartX, dragStartY;
var dragStartViewX0, dragStartViewX1, dragStartViewY0, dragStartViewY1;

var view_x0, view_x1, view_y0, view_y1


function resetZoom() {
    // Initialise zoom to have all tiles visible.
    view_x0 = -1;
    view_x1 = chipdb.device.width;
    view_y0 = -1;
    view_y1 = chipdb.device.height;
}


function wheelHandler(event) {
    // Zoom the view.

    if (!dataLoadComplete)
	return true;

    var del = Math.pow(1.023, event.deltaY);
    var canvas = document.getElementById("canvas1");
    var cx = event.pageX - canvas.offsetLeft;
    var cy = event.pageY - canvas.offsetTop;
    var wld = canvas2world(canvas, cx, cy);
    var wx = wld[0];
    var wy = wld[1];
    var a1 = wx - view_x0;
    var a2 = view_x1 - wx;
    var b1 = wy - view_y0;
    var b2 = view_y1 - wy;
    view_x0 = wx - del*a1;
    view_x1 = wx + del*a2;
    view_y0 = wy - del*b1;
    view_y1 = wy + del*b2;
    scheduleRedraw();
    event.preventDefault();
    return false;
}


function keyHandler(event) {
    if (!dataLoadComplete)
	return true;
    if (event.key == "Home") {
	resetZoom();
	scheduleRedraw();
	event.preventDefault();
	return false;
    }
    return true;
}


function mouseDownHandler(event) {
    if (!dataLoadComplete)
	return true;

    var canvas = document.getElementById("canvas1");
    var cx = event.pageX - canvas.offsetLeft;
    var cy = event.pageY - canvas.offsetTop;
    mouseDown = true;
    dragStartX = cx;
    dragStartY = cy;
    dragStartViewX0 = view_x0;
    dragStartViewX1 = view_x1;
    dragStartViewY0 = view_y0;
    dragStartViewY1 = view_y1;
    return true;
}


function mouseUpHandler(event) {
    mouseDown = false;
    draggingMouse = false;

    if (!dataLoadComplete)
	return true;

    return true;
}


function mouseMoveHandler(event) {
    if (!dataLoadComplete)
	return true;

    var canvas = document.getElementById("canvas1");
    var cx = event.pageX - canvas.offsetLeft;
    var cy = event.pageY - canvas.offsetTop;

    // Handle mouse-over highlighting.
    if (cx >= 0 && cx < canvas.width && cy >= 0 && cy < canvas.height) {
	var tc = canvas2TileXY(canvas, cx, cy);
	var oldHighlight = highLightSupernet;
	checkWireHighlight(tc[0], tc[1], tc[2], tc[3]);
	if (oldHighlight != highLightSupernet) {
	    document.getElementById("statustext").textContent =
		"Net: " + getHighlightedNetLabel();
	    scheduleRedraw();
	}
    } else {
	if (highLightSupernet != undefined) {
	    highLightSupernet = undefined;
	    scheduleRedraw();
	}
    }

    // Handle mouse drag, for panning.
    if (!mouseDown)
	return true;
    var dx = cx - dragStartX;
    var dy = cy - dragStartY;
    if (!draggingMouse && dx*dx + dy*dy > 5*5)
	draggingMouse = true;

    if (draggingMouse) {
	var delx = dx/canvas.width*(dragStartViewX1-dragStartViewX0);
	var dely = dy/canvas.height*(dragStartViewY1-dragStartViewY0);
	view_x0 = dragStartViewX0 - delx;
	view_x1 = dragStartViewX1 - delx;
	view_y0 = dragStartViewY0 + dely;
	view_y1 = dragStartViewY1 + dely;
	scheduleRedraw();
    }

    return true;
}


function focusOutHandler(event) {
    mouseDown = false;
    draggingMouse = false;
    return true;
}


function setupEventHandlers() {
    canvas = document.getElementById("canvas1");
    canvas.addEventListener("wheel", wheelHandler, false);
    document.addEventListener("keypress", keyHandler, true);
    canvas.addEventListener("mousedown", mouseDownHandler, false);
    document.addEventListener("mouseup", mouseUpHandler, false);
    document.addEventListener("mousemove", mouseMoveHandler, false);
    document.addEventListener("focusout", focusOutHandler, false);

    var fileinput = document.getElementById("ascfileinput");
    fileinput.addEventListener("change", readDotAsc, false);
}


// Redrawing management.

var needRedraw = false;

function redrawIfNeeded() {
    if (needRedraw) {
	redraw();
	needRedraw = false;
	// var txt;
	// if (highLightSupernet != undefined)
	//     txt = getHighlightedNetLabel();
	// else
	//     txt = "View: " +
	//     "X: " + Math.floor(view_x0 + 0.5).toString() +
	//     ".." + Math.ceil(view_x1 - 0.5).toString() +
	//     "  Y: " + Math.floor(view_y0 + 0.5).toString() +
	//     ".." + Math.ceil(view_y1 - 0.5).toString();
	// document.getElementById("statustext").textContent = txt
    }
}

// Do redraws asynchroneously. This way, if a slow redraw causes multiple updates
// to queue up meanwhile, we only need a single extra redraw to handle all pending
// updates, and we avoid updates getting too lagged.
function scheduleRedraw() {
    needRedraw = true;
    //document.getElementById("statustext").textContent = "Redrawing...";
    setTimeout(redrawIfNeeded, 0);
}


function redraw() {
    var canvas = document.getElementById("canvas1");
    var c = canvas.getContext("2d");
    var wx = canvas.width;
    var wy = canvas.height;

    c.fillStyle = "#FFFFFF";
    c.fillRect(0, 0, wx, wy);
    c.strokeStyle = "#000000";
    c.lineWidth = 1;

    drawTiles(canvas, g_tiles, chipdb);

    // Flash any high-lighted net.
    if (highLightSupernet != undefined)
	setTimeout(scheduleRedraw, 250);
}


var chipdb_loaded = false;
var asc_file_fetched = false;
var asc_file_parser;

function maybe_parse_asc() {
    if (!chipdb_loaded || !asc_file_fetched)
	return;
    g_asc_data = { };
    g_symtable = new Array(chipdb.device.num_nets);
    asc_parse_step(asc_file_parser, chipdb, g_tiles, g_symtable, g_asc_data, function() {
	document.getElementById("statustext").textContent = ".asc loaded ok";
	asc_file_parser = null;
	asc_postprocess(chipdb, g_tiles, g_asc_data);
	calcTiles(g_tiles);
	dataLoadComplete = true;
	scheduleRedraw();
    });
}


function readDotAsc(event) {
    if (!chipdb_loaded || !asc_file_fetched)
	return;
    var file = event.target.files[0];
    if (!file)
	return;
    var fr = new FileReader();
    fr.onload = function (dataEvent) {
	var fileData = dataEvent.target.result;
	asc_file_parser = getLineParser(fileData);
	g_tiles = mk_tiles(chipdb);
	maybe_parse_asc();
    }
    fr.readAsText(file);
}


function loaddata() {
    var xhr = new XMLHttpRequest();
    xhr.onreadystatechange = function() {
	if (xhr.readyState == 4) {
	    if (xhr.status == 200) {
		document.getElementById("statustext").textContent = "ChipDB loaded ok";
		chipdb = { };
		var parser = getLineParser(xhr.responseText);
		chipdb_parse_step(parser, chipdb, function (loaded_chipdb) {
		    console.log("Loaded: " + loaded_chipdb.device.device + " size " + chipdb.device.width + "x" + chipdb.device.height + " @ " + chipdb.device.num_nets + " nets.");

		    chipdb_loaded = true;
		    resetZoom();

		    // Initialise a tiles array for drawing.
		    g_tiles = mk_tiles(chipdb);
		    maybe_parse_asc();
		    scheduleRedraw();
		});
	    } else {
		document.getElementById("statustext").innerHTML = "<b>Error loading chipdb data (HTTP code: " + xhr.status + "</b>";
	    }
	}
    };
    xhr.open("GET", datafilename, true);
    xhr.responseType = "text";
    xhr.send();

    var xhr2 = new XMLHttpRequest();
    xhr2.onreadystatechange = function() {
	if (xhr2.readyState == 4) {
	    if (xhr2.status == 200) {
		asc_file_fetched = true;
		asc_file_parser = getLineParser(xhr2.responseText);
		maybe_parse_asc();
	    } else {
		document.getElementById("statustext").innerHTML = "<b>Error loading .asc data (HTTP code: " + xhr2.status + "</b>";
	    }
	}
    };
    xhr2.open("GET", ascfilename, true);
    xhr2.responseType = "text";
    xhr2.send();
}

setupEventHandlers();
loaddata();

  </script>

</body>
</html>
